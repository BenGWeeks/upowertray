name: Publish to PPA

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (without v prefix)'
        required: true
      series:
        description: 'Ubuntu series (e.g., noble, oracular, questing)'
        required: true
        default: 'questing'

env:
  PPA: ppa:benweeks/upowertray
  DEBFULLNAME: "Ben Weeks"
  DEBEMAIL: "ben.weeks@outlook.com"

jobs:
  ppa:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        series: [noble, oracular, questing]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ github.event.inputs.version || github.ref_name }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "series=${{ github.event.inputs.series }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "series=${{ matrix.series }}" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gpg \
            qt6-base-dev qt6-tools-dev cmake build-essential libgl1-mesa-dev

      - name: Import GPG key and configure
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # Import key
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

          # Configure gpg for non-interactive use
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

          # Create a wrapper script for signing
          cat > ~/gpg-passphrase.sh << 'SCRIPT'
          #!/bin/bash
          echo "$GPG_PASSPHRASE"
          SCRIPT
          chmod +x ~/gpg-passphrase.sh

          # Test signing works
          echo "test" | gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --pinentry-mode loopback -s > /dev/null

      - name: Download upstream tarball
        run: |
          VERSION=${{ steps.version.outputs.version }}
          curl -sL "https://github.com/${{ github.repository }}/archive/v${VERSION}.tar.gz" \
            -o ../upowertray_${VERSION}.orig.tar.gz

      - name: Update changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          SERIES=${{ steps.version.outputs.series }}
          DATE=$(date -R)

          cat > debian/changelog << EOF
          upowertray (${VERSION}-1~${SERIES}1) ${SERIES}; urgency=medium

            * Release ${VERSION}
            * See https://github.com/${{ github.repository }}/releases/tag/v${VERSION}

           -- Ben Weeks <ben.weeks@outlook.com>  ${DATE}
          EOF

      - name: Build and sign source package
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Build unsigned first
          debuild -S -sa -us -uc

          # Sign with passphrase
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback \
            --default-key "$GPG_KEY_ID" --clearsign ../upowertray_*.dsc
          mv ../upowertray_*.dsc.asc ../upowertray_*.dsc || true

          # Sign changes file
          debsign -k"$GPG_KEY_ID" --no-re-sign -p"gpg --batch --yes --passphrase '$GPG_PASSPHRASE' --pinentry-mode loopback" ../upowertray_*_source.changes

      - name: Upload to PPA
        run: |
          dput ${{ env.PPA }} ../upowertray_*_source.changes
